{
  "name": "📢 프로모션 이메일 처리 워크플로우",
  "nodes": [
    {
      "parameters": {},
      "id": "workflow-trigger",
      "name": "워크플로우 트리거",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// 프로모션 이메일 키워드 분석 및 카테고리 분류\nconst data = $input.item(0).json;\n\n// 관심 키워드 목록\nconst interestKeywords = {\n  discount: ['할인', '세일', 'sale', 'discount', '특가', '이벤트'],\n  tech: ['AI', '인공지능', '개발', 'programming', '코딩', '테크', 'SaaS'],\n  education: ['강의', '교육', '수업', 'course', 'learning', '온라인'],\n  shopping: ['쇼핑', '구매', '상품', 'product', '배송', '무료'],\n  finance: ['투자', '금융', '카드', '대출', '보험', '적금']\n};\n\n// 키워드 매칭 함수\nfunction findMatchingKeywords(text, keywords) {\n  const found = [];\n  const textLower = text.toLowerCase();\n  for (const [category, words] of Object.entries(keywords)) {\n    const matches = words.filter(word => textLower.includes(word.toLowerCase()));\n    if (matches.length > 0) {\n      found.push({ category, matches });\n    }\n  }\n  return found;\n}\n\nconst emailText = `${data.subject} ${data.body}`.toLowerCase();\nconst matchedKeywords = findMatchingKeywords(emailText, interestKeywords);\n\n// 관심도 점수 계산 (매칭된 키워드 수에 따라)\nconst interestScore = matchedKeywords.reduce((score, match) => score + match.matches.length, 0);\nconst isInteresting = interestScore >= 2; // 2개 이상 키워드 매칭시 관심 있음\n\nconst promotionalData = {\n  email_info: {\n    from: data.from,\n    subject: data.subject,\n    summary: data.summary,\n    timestamp: data.timestamp,\n    messageId: data.messageId\n  },\n  analysis: {\n    matched_keywords: matchedKeywords,\n    interest_score: interestScore,\n    is_interesting: isInteresting,\n    categories: matchedKeywords.map(m => m.category)\n  },\n  sheets_data: {\n    values: [[\n      new Date().toISOString().split('T')[0], // 날짜\n      data.from,                              // 발신자\n      data.subject,                           // 제목\n      matchedKeywords.map(m => m.category).join(', '), // 카테고리\n      interestScore,                          // 관심도\n      isInteresting ? '관심있음' : '일반',      // 분류\n      matchedKeywords.map(m => m.matches.join(', ')).join(' | ') // 매칭 키워드\n    ]]\n  }\n};\n\nreturn [{ json: promotionalData }];"
      },
      "id": "keyword-analyzer",
      "name": "키워드 분석",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "archive",
        "messageId": "={{ $json.email_info.messageId }}"
      },
      "id": "gmail-archive",
      "name": "Gmail 아카이브",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [680, 200],
      "credentials": {
        "gmailOAuth2": {
          "id": "gmail_credentials",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "{{ $vars.PROMOTIONAL_SPREADSHEET_ID }}",
          "mode": "list"
        },
        "sheetName": "프로모션 로그",
        "columnToMatchOn": "A",
        "valueToMatchOn": "={{ $json.email_info.timestamp }}",
        "options": {
          "continue": true,
          "valueInputMode": "USER_ENTERED"\n        },\n        "dataStartRow": 2,\n        "keyRowHeaders": [\n          \"날짜\",\n          \"발신자\", \n          \"제목\",\n          \"카테고리\",\n          \"관심도\",\n          \"분류\",\n          \"키워드\"\n        ],\n        \"values\": \"={{ $json.sheets_data.values }}\"\n      },\n      \"id\": \"sheets-logging\",\n      \"name\": \"스프레드시트 로깅\",\n      \"type\": \"n8n-nodes-base.googleSheets\",\n      \"typeVersion\": 4,\n      \"position\": [680, 300],\n      \"credentials\": {\n        \"googleSheetsOAuth2Api\": {\n          \"id\": \"google_sheets_credentials\",\n          \"name\": \"Google Sheets OAuth2\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"id\": \"interesting-promo\",\n              \"leftValue\": \"={{ $json.analysis.is_interesting }}\",\n              \"rightValue\": true,\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"true\"\n              }\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"id\": \"interest-check\",\n      \"name\": \"관심도 체크\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [900, 300]\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"addLabels\",\n        \"messageId\": \"={{ $json.email_info.messageId }}\",\n        \"labelIds\": [\"Label_3456789012\"]\n      },\n      \"id\": \"gmail-interesting-label\",\n      \"name\": \"Gmail 관심 라벨\",\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"typeVersion\": 2,\n      \"position\": [1120, 200],\n      \"credentials\": {\n        \"gmailOAuth2\": {\n          \"id\": \"gmail_credentials\",\n          \"name\": \"Gmail OAuth2\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"oAuth2\",\n        \"select\": \"user\",\n        \"user\": {\n          \"__rl\": true,\n          \"value\": \"U3456789012\",\n          \"mode\": \"list\",
          \"cachedResultName\": \"개인DM\"\n        },\n        \"text\": \"📢 *관심있는 프로모션 이메일 발견!*\\n\\n*발신자:* {{ $json.email_info.from }}\\n*제목:* {{ $json.email_info.subject }}\\n*카테고리:* {{ $json.analysis.categories.join(', ') }}\\n*매칭 키워드:* {{ $json.analysis.matched_keywords.map(m => m.matches.join(', ')).join(' | ') }}\\n\\n<https://mail.google.com/mail/u/0/#inbox/{{ $json.email_info.messageId }}|이메일 확인하기>\"\n      },\n      \"id\": \"slack-interesting-alert\",\n      \"name\": \"개인 관심 알림\",\n      \"type\": \"n8n-nodes-base.slack\",\n      \"typeVersion\": 2.1,\n      \"position\": [1120, 300],\n      \"credentials\": {\n        \"slackOAuth2Api\": {\n          \"id\": \"slack_credentials\",\n          \"name\": \"Slack OAuth2\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"cronExpression\",\n              \"expression\": \"0 17 * * 5\"\n            }\n          ]\n        }\n      },\n      \"id\": \"weekly-schedule\",\n      \"name\": \"주간 스케줄 (금요일 5PM)\",\n      \"type\": \"n8n-nodes-base.cron\",\n      \"typeVersion\": 1,\n      \"position\": [240, 600]\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"readRows\",\n        \"documentId\": {\n          \"__rl\": true,\n          \"value\": \"{{ $vars.PROMOTIONAL_SPREADSHEET_ID }}\",\n          \"mode\": \"list\"\n        },\n        \"sheetName\": \"프로모션 로그\",\n        \"options\": {\n          \"range\": \"A2:G1000\"\n        }\n      },\n      \"id\": \"weekly-data-fetch\",\n      \"name\": \"주간 데이터 조회\",\n      \"type\": \"n8n-nodes-base.googleSheets\",\n      \"typeVersion\": 4,\n      \"position\": [460, 600],\n      \"credentials\": {\n        \"googleSheetsOAuth2Api\": {\n          \"id\": \"google_sheets_credentials\",\n          \"name\": \"Google Sheets OAuth2\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// 주간 프로모션 이메일 요약 생성\\nconst data = $input.all();\\n\\n// 지난 7일간의 데이터 필터링\\nconst oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\\nconst weeklyData = data.filter(item => {\\n  const emailDate = new Date(item.json[0]); // 첫 번째 컬럼이 날짜\\n  return emailDate >= oneWeekAgo;\\n});\\n\\n// 통계 계산\\nconst totalEmails = weeklyData.length;\\nconst interestingEmails = weeklyData.filter(item => item.json[5] === '관심있음').length;\\n\\n// 카테고리별 집계\\nconst categoryStats = {};\\nweeklyData.forEach(item => {\\n  const categories = item.json[3].split(', ').filter(c => c);\\n  categories.forEach(cat => {\\n    categoryStats[cat] = (categoryStats[cat] || 0) + 1;\\n  });\\n});\\n\\n// 발신자별 집계 (상위 5개)\\nconst senderStats = {};\\nweeklyData.forEach(item => {\\n  const sender = item.json[1];\\n  senderStats[sender] = (senderStats[sender] || 0) + 1;\\n});\\nconst topSenders = Object.entries(senderStats)\\n  .sort(([,a], [,b]) => b - a)\\n  .slice(0, 5);\\n\\n// Slack 메시지 생성\\nconst summaryMessage = {\\n  text: \\\"📈 *주간 프로모션 이메일 요약*\\\",\\n  blocks: [\\n    {\\n      \\\"type\\\": \\\"header\\\",\\n      \\\"text\\\": {\\n        \\\"type\\\": \\\"plain_text\\\",\\n        \\\"text\\\": \\\"📈 주간 프로모션 이메일 요약 (지난 7일)\\\"\\n      }\\n    },\\n    {\\n      \\\"type\\\": \\\"section\\\",\\n      \\\"fields\\\": [\\n        {\\n          \\\"type\\\": \\\"mrkdwn\\\",\\n          \\\"text\\\": `*총 이메일:*\\\\n${totalEmails}개`\\n        },\\n        {\\n          \\\"type\\\": \\\"mrkdwn\\\",\\n          \\\"text\\\": `*관심 이메일:*\\\\n${interestingEmails}개`\\n        }\\n      ]\\n    },\\n    {\\n      \\\"type\\\": \\\"section\\\",\\n      \\\"text\\\": {\\n        \\\"type\\\": \\\"mrkdwn\\\",\\n        \\\"text\\\": `*카테고리별 통계:*\\\\n${Object.entries(categoryStats).map(([cat, count]) => `• ${cat}: ${count}개`).join('\\\\n')}`\\n      }\\n    },\\n    {\\n      \\\"type\\\": \\\"section\\\",\\n      \\\"text\\\": {\\n        \\\"type\\\": \\\"mrkdwn\\\",\\n        \\\"text\\\": `*주요 발신자 (Top 5):*\\\\n${topSenders.map(([sender, count], idx) => `${idx + 1}. ${sender}: ${count}개`).join('\\\\n')}`\\n      }\\n    },\\n    {\\n      \\\"type\\\": \\\"actions\\\",\\n      \\\"elements\\\": [\\n        {\\n          \\\"type\\\": \\\"button\\\",\\n          \\\"text\\\": {\\n            \\\"type\\\": \\\"plain_text\\\",\\n            \\\"text\\\": \\\"상세 로그 보기\\\"\\n          },\\n          \\\"url\\\": `https://docs.google.com/spreadsheets/d/{{ $vars.PROMOTIONAL_SPREADSHEET_ID }}`,\\n          \\\"style\\\": \\\"primary\\\"\\n        }\\n      ]\\n    }\\n  ]\\n};\\n\\nreturn [{ json: summaryMessage }];\"\n      },\n      \"id\": \"weekly-summary\",\n      \"name\": \"주간 요약 생성\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [680, 600]\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"oAuth2\",\n        \"select\": \"channel\",\n        \"channelId\": {\n          \"__rl\": true,\n          \"value\": \"C4567890123\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"#weekly-summary\"\n        },\n        \"text\": \"={{ $json.text }}\",\n        \"blocksUi\": {\n          \"blocksValues\": [\n            {\n              \"block\": \"={{ JSON.stringify($json.blocks) }}\"\n            }\n          ]\n        },\n        \"otherOptions\": {\n          \"mrkdwn\": true\n        }\n      },\n      \"id\": \"slack-weekly-summary\",\n      \"name\": \"주간 요약 발송\",\n      \"type\": \"n8n-nodes-base.slack\",\n      \"typeVersion\": 2.1,\n      \"position\": [900, 600],\n      \"credentials\": {\n        \"slackOAuth2Api\": {\n          \"id\": \"slack_credentials\",\n          \"name\": \"Slack OAuth2\"\n        }\n      }\n    }\n  ],\n  \"connections\": {\n    \"워크플로우 트리거\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"키워드 분석\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"키워드 분석\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Gmail 아카이브\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"스프레드시트 로깅\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"스프레드시트 로깅\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"관심도 체크\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"관심도 체크\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Gmail 관심 라벨\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"개인 관심 알림\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"주간 스케줄 (금요일 5PM)\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"주간 데이터 조회\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"주간 데이터 조회\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"주간 요약 생성\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"주간 요약 생성\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"주간 요약 발송\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"tags\": [\n    {\n      \"createdAt\": \"2024-12-19T10:00:00.000Z\",\n      \"updatedAt\": \"2024-12-19T10:00:00.000Z\",\n      \"id\": \"email-automation\",\n      \"name\": \"이메일 자동화\"\n    }\n  ],\n  \"triggerCount\": 1,\n  \"updatedAt\": \"2024-12-19T10:00:00.000Z\",\n  \"versionId\": \"1\"\n} 